<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://jakarta.faces.html"
      xmlns:f="http://jakarta.faces.core">

<h:head>
    <title>Directorio de Autores</title>
    <h:outputScript name="jsf.js" library="jakarta.faces" target="head"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .card { margin-bottom: 2rem; }
    </style>
</h:head>

<h:body>
    <div class="container">
        <h2 class="text-center mb-4">Directorio de Autores</h2>

        <h:form id="mainForm">
            <div class="card">
                <div class="card-header fw-bold">FORMULARIO DE AUTORES</div>
                <div class="card-body">
                    <h:panelGrid columns="2" styleClass="w-100" columnClasses="w-25,w-75">
                        <h:outputLabel for="nombre" value="Nombre del Autor:" styleClass="form-label"/>
                        <h:inputText id="nombre" value="#{authorBean.author.firstName}" styleClass="form-control" required="true" requiredMessage="El nombre es obligatorio."/>

                        <h:outputLabel for="apellido" value="Apellido del Autor:" styleClass="form-label"/>
                        <h:inputText id="apellido" value="#{authorBean.author.lastName}" styleClass="form-control" required="true" requiredMessage="El apellido es obligatorio."/>

                        <h:outputLabel for="fechaNacimiento" value="Fecha de Nacimiento:" styleClass="form-label"/>
                        <h:inputText id="fechaNacimiento" type="date" value="#{authorBean.author.birthDate}" styleClass="form-control">
                            <f:convertDateTime pattern="yyyy-MM-dd"/>
                        </h:inputText>

                        <h:outputLabel for="telefono" value="Teléfono:" styleClass="form-label"/>
                        <h:inputText id="telefono" value="#{authorBean.author.phone}" styleClass="form-control" placeholder="####-####">
                            <f:validator validatorId="svPhoneValidator"/>
                        </h:inputText>

                        <h:outputLabel for="genero" value="Género:" styleClass="form-label"/>
                        <h:selectOneMenu id="genero" value="#{literaryGenreBean.selectedGenreId}" styleClass="form-select" required="true" requiredMessage="Debe seleccionar un género.">
                            <f:selectItem itemLabel="-- Seleccione un género --" itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{literaryGenreBean.genres}" var="g" itemValue="#{g.id}" itemLabel="#{g.name}"/>
                        </h:selectOneMenu>
                    </h:panelGrid>

                    <h:commandButton value="#{authorBean.author.id == null ? 'AGREGAR' : 'ACTUALIZAR'}" action="#{authorBean.addAuthor()}" styleClass="btn btn-primary mt-3">
                        <f:ajax execute="@form" render="@form authorTable countGroup"/>
                    </h:commandButton>

                    <div class="mt-3">
                        <h:outputLabel value="Validaciones" styleClass="fw-bold"/><br/>
                        <div class="border p-2" style="min-height: 80px;">
                            <h:messages styleClass="text-danger"/>
                            <h:outputText value="#{authorBean.message}" styleClass="text-success"/>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header fw-bold">DIRECTORIO DE AUTORES</div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h:outputLabel for="genreFilter" value="Filtrar por Género: " styleClass="me-2"/>
                            <h:selectOneMenu id="genreFilter" value="#{authorBean.selectedGenreFilterId}" styleClass="form-select d-inline-block w-auto">
                                <f:selectItem itemLabel="Todos" itemValue="#{null}"/>
                                <f:selectItems value="#{literaryGenreBean.genres}" var="g" itemValue="#{g.id}" itemLabel="#{g.name}"/>
                                <f:ajax listener="#{authorBean.applyGenreFilter()}" render="authorTable countGroup"/>
                            </h:selectOneMenu>
                        </div>
                    </div>

                    <h:dataTable id="authorTable" value="#{authorBean.filteredAuthors}" var="auth" styleClass="table table-striped table-bordered">
                        <h:column>
                            <f:facet name="header">ID</f:facet>
                            #{auth.id}
                        </h:column>
                        <h:column>
                            <f:facet name="header">Nombre</f:facet>
                            #{auth.firstName} #{auth.lastName}
                        </h:column>
                        <h:column>
                            <f:facet name="header">Teléfono</f:facet>
                            #{auth.phone}
                        </h:column>
                        <h:column>
                            <f:facet name="header">Nacimiento</f:facet>
                            <h:outputText value="#{auth.birthDate}">
                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </h:column>
                        <h:column>
                            <f:facet name="header">Género</f:facet>
                            #{auth.literaryGenre != null ? auth.literaryGenre.name : 'Sin género'}
                        </h:column>
                        <h:column>
                            <f:facet name="header">Operaciones</f:facet>
                            <h:commandButton value="EDITAR" action="#{authorBean.editAuthor(auth)}" styleClass="btn btn-sm btn-warning me-2">
                                <f:ajax execute="@this" render="@form"/>
                            </h:commandButton>
                            <h:commandButton value="BORRAR" action="#{authorBean.deleteAuthor(auth)}" styleClass="btn btn-sm btn-danger" onclick="return confirm('¿Está seguro de eliminar a este autor?');">
                                <f:ajax execute="@this" render="authorTable countGroup"/>
                            </h:commandButton>
                        </h:column>
                    </h:dataTable>

                    <hr/>
                    <div class="d-flex justify-content-end align-items-center">
                        <h:panelGroup id="countGroup" layout="block" styleClass="me-3">
                            <h:outputText value="Número de autores: #{authorBean.filteredAuthors.size()}"/>
                        </h:panelGroup>
                        <h:commandButton value="CONTAR" styleClass="btn btn-secondary">
                            <f:ajax render="countGroup"/>
                        </h:commandButton>
                    </div>
                </div>
            </div>
        </h:form>
    </div>
</h:body>

</html>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core">

<h:head>
    <title>Directorio de Autores</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <h:outputStylesheet library="css" name="styles.css"/>

</h:head>

<h:body>
    <div class="container-fluid">
        <h2 class="text-center mb-4">Directorio de Autores</h2>

        <h:form id="mainForm">
            <!-- FORMULARIO DE AUTORES -->
            <div class="card">
                <div class="card-header">FORMULARIO DE AUTORES</div>
                <div class="card-body">
                    <table class="form-table">
                        <tr>
                            <td><h:outputLabel for="nombre" value="Nombre:"/></td>
                            <td>
                                <h:inputText id="nombre"
                                             value="#{authorBean.author.firstName}"
                                             styleClass="form-control"
                                             required="true"
                                             requiredMessage="El nombre es obligatorio."/>
                            </td>
                        </tr>
                        <tr>
                            <td><h:outputLabel for="apellido" value="Apellido:"/></td>
                            <td>
                                <h:inputText id="apellido"
                                             value="#{authorBean.author.lastName}"
                                             styleClass="form-control"
                                             required="true"
                                             requiredMessage="El apellido es obligatorio."/>
                            </td>
                        </tr>
                        <tr>
                            <td><h:outputLabel for="fechaNacimiento" value="Fecha de Nacimiento:"/></td>
                            <td>
                                <h:inputText id="fechaNacimiento"
                                             type="date"
                                             value="#{authorBean.author.birthDate}"
                                             styleClass="form-control"
                                             required="true"
                                             requiredMessage="La fecha de nacimiento es obligatoria.">
                                    <f:convertDateTime pattern="yyyy-MM-dd"/>
                                </h:inputText>
                            </td>
                        </tr>
                        <tr>
                            <td><h:outputLabel for="telefono" value="Telefono:"/></td>
                            <td>
                                <h:inputText id="telefono"
                                             value="#{authorBean.author.phone}"
                                             styleClass="form-control"
                                             placeholder="####-####">
                                    <f:validator validatorId="svPhoneValidator"/>
                                </h:inputText>
                                <h:message for="telefono" style="color:red; font-weight:bold;"/>
                            </td>
                        </tr>
                        <tr>
                            <td><h:outputLabel for="genero" value="Genero Literario:"/></td>
                            <td>
                                <h:selectOneMenu id="genero"
                                                 value="#{literaryGenreBean.selectedGenreId}"
                                                 styleClass="form-select"
                                                 required="true"
                                                 requiredMessage="Debe seleccionar un genero.">
                                    <f:selectItem itemLabel="-- Seleccione un genero --"
                                                  itemValue="#{null}"
                                                  noSelectionOption="true"/>
                                    <f:selectItems value="#{literaryGenreBean.genres}"
                                                   var="g"
                                                   itemValue="#{g.id}"
                                                   itemLabel="#{g.name}"/>
                                </h:selectOneMenu>
                            </td>
                        </tr>
                    </table>

                    <div class="mt-3">
                        <h:commandButton value="#{authorBean.author.id == null ? 'AGREGAR' : 'ACTUALIZAR'}"
                                         action="#{authorBean.addAuthor()}"
                                         styleClass="btn btn-primary">
                            <f:ajax execute="@form" render="@form authorTable countGroup"/>
                        </h:commandButton>
                    </div>

                    <div class="validation-box">
                        <h:outputLabel value="Validaciones:" styleClass="fw-bold d-block mb-2"/>
                        <h:messages styleClass="text-danger" globalOnly="true"/>
                        <h:outputText value="#{authorBean.message}"
                                      styleClass="text-success fw-bold"
                                      rendered="#{not empty authorBean.message}"/>
                    </div>
                </div>
            </div>

            <!-- DIRECTORIO DE AUTORES -->
            <div class="card">
                <div class="card-header">DIRECTORIO DE AUTORES</div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="filter-section">
                        <div class="row align-items-center mb-3">
                            <div class="col-auto">
                                <h:outputLabel for="genreFilter" value="Filtrar por Genero:" styleClass="form-label mb-0"/>
                            </div>
                            <div class="col-auto">
                                <h:selectOneMenu id="genreFilter"
                                                 value="#{authorBean.selectedGenreFilterId}"
                                                 styleClass="form-select">
                                    <f:selectItem itemLabel="Todos" itemValue="#{null}"/>
                                    <f:selectItems value="#{literaryGenreBean.genres}"
                                                   var="g"
                                                   itemValue="#{g.id}"
                                                   itemLabel="#{g.name}"/>
                                    <f:ajax listener="#{authorBean.applyGenreFilter()}"
                                            render="authorTable countGroup"/>
                                </h:selectOneMenu>
                            </div>
                        </div>

                        <div class="row align-items-center">
                            <div class="col-auto">
                                <h:outputLabel for="searchFilter" value="Buscar Autor:" styleClass="form-label mb-0"/>
                            </div>
                            <div class="col-auto">
                                <h:inputText id="searchFilter"
                                             value="#{authorBean.searchText}"
                                             styleClass="form-control"
                                             placeholder="Nombre o apellido...">
                                    <f:ajax event="keyup"
                                            listener="#{authorBean.applySearchFilter()}"
                                            render="authorTable countGroup"/>
                                </h:inputText>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de autores -->
                    <h:dataTable id="authorTable"
                                 value="#{authorBean.filteredAuthors}"
                                 var="auth"
                                 styleClass="dataTable table-hover"
                                 headerClass="table-header"
                                 rowClasses="table-row">

                        <h:column>
                            <f:facet name="header">ID</f:facet>
                            <h:outputText value="#{auth.id}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Nombre</f:facet>
                            <h:outputText value="#{auth.firstName}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Apellido</f:facet>
                            <h:outputText value="#{auth.lastName}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Telefono</f:facet>
                            <h:outputText value="#{auth.phone}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Nacimiento</f:facet>
                            <h:outputText value="#{auth.birthDate}">
                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Genero</f:facet>
                            <h:outputText value="#{auth.literaryGenre != null ? auth.literaryGenre.name : 'Sin genero'}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Operaciones</f:facet>
                            <h:commandButton value="EDITAR"
                                             action="#{authorBean.editAuthor(auth)}"
                                             styleClass="btn btn-sm btn-warning btn-operations">
                                <f:ajax execute="@this" render="@form"/>
                            </h:commandButton>
                            <h:commandButton value="BORRAR"
                                             action="#{authorBean.deleteAuthor(auth)}"
                                             styleClass="btn btn-sm btn-danger"
                                             onclick="return confirm('¿Esta seguro de eliminar a este autor?');">
                                <f:ajax execute="@this" render="authorTable countGroup"/>
                            </h:commandButton>
                        </h:column>
                    </h:dataTable>

                    <!-- Seccion de conteo -->
                    <div class="count-section">
                        <h:panelGroup id="countGroup" layout="block">
                            <strong>Numero de autores: </strong>
                            <span class="badge bg-primary fs-6">#{authorBean.filteredAuthors.size()}</span>
                        </h:panelGroup>
                        <h:commandButton value="CONTAR" styleClass="btn btn-secondary">
                            <f:ajax render="countGroup"/>
                        </h:commandButton>
                    </div>
                </div>
            </div>
        </h:form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</h:body>

</html>

